<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2FA Authentication System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 20px;
            position: relative;
            overflow: auto;
        }

        /* Animated background circles */
        .bg-circle {
            position: absolute;
            border-radius: 50%;
            opacity: 0.1;
            animation: float 20s infinite ease-in-out;
        }

        .circle-1 {
            width: 300px;
            height: 300px;
            background: white;
            top: -100px;
            left: -100px;
            animation-delay: 0s;
        }

        .circle-2 {
            width: 200px;
            height: 200px;
            background: white;
            bottom: -50px;
            right: -50px;
            animation-delay: 5s;
        }

        .circle-3 {
            width: 150px;
            height: 150px;
            background: white;
            top: 50%;
            right: 10%;
            animation-delay: 10s;
        }

        @keyframes float {
            0%, 100% { transform: translate(0, 0) scale(1); }
            33% { transform: translate(30px, -50px) scale(1.1); }
            66% { transform: translate(-20px, 30px) scale(0.9); }
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 450px;
            width: 100%;
            overflow: hidden;
            position: relative;
            z-index: 10;
            animation: slideUp 0.5s ease-out;
            margin: 20px 0;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 40px 30px;
            text-align: center;
            color: white;
            position: relative;
        }

        .header-icon {
            width: 80px;
            height: 80px;
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            font-size: 40px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 14px;
        }

        .content {
            padding: 40px 30px;
            max-height: 70vh;
            overflow-y: auto;
        }

        .content::-webkit-scrollbar {
            width: 6px;
        }

        .content::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        .content::-webkit-scrollbar-thumb {
            background: #667eea;
            border-radius: 10px;
        }

        .content::-webkit-scrollbar-thumb:hover {
            background: #764ba2;
        }

        .screen {
            display: none;
        }

        .screen.active {
            display: block;
            animation: fadeIn 0.5s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .form-group {
            margin-bottom: 25px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
            font-size: 14px;
        }

        input[type="text"],
        input[type="email"],
        input[type="password"] {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 15px;
            transition: all 0.3s;
            background: #f8f9fa;
        }

        input:focus {
            outline: none;
            border-color: #667eea;
            background: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
        }

        .input-icon {
            position: relative;
        }

        .input-icon input {
            padding-left: 45px;
        }

        .input-icon::before {
            content: attr(data-icon);
            position: absolute;
            left: 15px;
            top: 14px;
            font-size: 20px;
        }

        .btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }

        .btn-primary:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: #f0f0f0;
            color: #667eea;
            margin-top: 10px;
        }

        .btn-secondary:hover {
            background: #e0e0e0;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        .code-inputs {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin: 30px 0;
        }

        .code-input {
            width: 50px;
            height: 60px;
            text-align: center;
            font-size: 24px;
            font-weight: bold;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            background: #f8f9fa;
            transition: all 0.3s;
        }

        .code-input:focus {
            border-color: #667eea;
            background: white;
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .qr-code-container {
            text-align: center;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            margin: 20px 0;
        }

        .qr-code-image {
            max-width: 250px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            display: none;
        }

        .secret-key {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border: 2px dashed #667eea;
            font-family: monospace;
            font-size: 14px;
            word-break: break-all;
            color: #667eea;
            text-align: center;
        }

        .alert {
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            animation: slideDown 0.5s ease-out;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border-left: 4px solid #28a745;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border-left: 4px solid #dc3545;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border-left: 4px solid #17a2b8;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .link {
            color: #667eea;
            text-decoration: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .link:hover {
            color: #764ba2;
            text-decoration: underline;
        }

        .text-center {
            text-align: center;
            margin-top: 20px;
            font-size: 14px;
            color: #666;
        }

        .backup-codes {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin: 20px 0;
        }

        .backup-code {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            text-align: center;
            font-family: monospace;
            font-weight: bold;
            color: #667eea;
            border: 2px solid #e0e0e0;
        }

        .dashboard {
            text-align: center;
        }

        .user-info {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
        }

        .user-avatar {
            width: 80px;
            height: 80px;
            background: rgba(255,255,255,0.3);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 15px;
            font-size: 36px;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .tab {
            flex: 1;
            padding: 12px;
            background: #f0f0f0;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .password-toggle {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            font-size: 20px;
        }

        .input-wrapper {
            position: relative;
        }

        .qr-loading {
            display: block;
        }

        .backup-codes-container {
            display: none;
        }

        .verify-code-input {
            text-align: center;
            font-size: 24px;
            letter-spacing: 5px;
            width: 100%;
            padding: 14px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            background: #f8f9fa;
        }

        .domain-hint {
            color: #999;
            font-size: 12px;
            margin-top: 5px;
        }

        .password-hint {
            color: #999;
            font-size: 12px;
            margin-top: 5px;
        }

        .admin-hint {
            color: #999;
            font-size: 12px;
        }

        .status-container {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .status-label {
            color: #666;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .status-value {
            font-size: 24px;
            font-weight: bold;
        }

        .demo-info {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
            text-align: center;
        }

        /* Responsive */
        @media (max-width: 480px) {
            .container {
                margin: 10px;
            }
            
            .code-inputs {
                gap: 5px;
            }
            
            .code-input {
                width: 45px;
                height: 55px;
                font-size: 20px;
            }
            
            .backup-codes {
                grid-template-columns: 1fr;
            }
            
            .content {
                padding: 30px 20px;
            }
        }
    </style>
</head>
<body>
    <div class="bg-circle circle-1"></div>
    <div class="bg-circle circle-2"></div>
    <div class="bg-circle circle-3"></div>

    <div class="container">
        <div class="header">
            <div class="header-icon">üîê</div>
            <h1 id="headerTitle">Secure Login</h1>
            <p id="headerSubtitle">Multi-Tenant Authentication Platform</p>
        </div>

        <div class="content">
            <!-- Alert Container -->
            <div id="alertContainer"></div>

            <!-- Login Screen -->
            <div id="loginScreen" class="screen active">
                <form id="loginForm">
                    <div class="form-group">
                        <label>Organization Domain</label>
                        <div class="input-icon" data-icon="üè¢">
                            <input type="text" id="loginDomain" placeholder="acme-corp" required>
                        </div>
                        <div class="domain-hint">Use: acme-corp, tech-company, or startup-xyz</div>
                    </div>

                    <div class="form-group">
                        <label>Email Address</label>
                        <div class="input-icon" data-icon="üìß">
                            <input type="email" id="loginEmail" placeholder="test@acme-corp.com" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Password</label>
                        <div class="input-wrapper">
                            <div class="input-icon" data-icon="üîí">
                                <input type="password" id="loginPassword" placeholder="Password123" required>
                            </div>
                            <span class="password-toggle" onclick="togglePassword('loginPassword')">üëÅÔ∏è</span>
                        </div>
                        <div class="password-hint">Demo password: Password123</div>
                    </div>

                    <button type="submit" class="btn btn-primary">
                        <span id="loginBtnText">Continue to 2FA</span>
                    </button>
                </form>

                <div class="text-center">
                    Don't have an account? <a class="link" onclick="showScreen('registerScreen')">Register here</a>
                </div>

                <div class="demo-info">
                    <strong>Demo Accounts:</strong><br>
                    <small>Domains: acme-corp, tech-company, startup-xyz</small><br>
                    <small>Email: test@[domain].com</small><br>
                    <small>Password: Password123</small>
                </div>
            </div>

            <!-- Register Screen -->
            <div id="registerScreen" class="screen">
                <form id="registerForm">
                    <div class="form-group">
                        <label>Organization Domain</label>
                        <div class="input-icon" data-icon="üè¢">
                            <input type="text" id="regDomain" placeholder="your-company" required>
                        </div>
                        <div class="domain-hint">
                            Choose a unique name for your organization
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Full Name</label>
                        <div class="input-icon" data-icon="üë§">
                            <input type="text" id="regName" placeholder="John Doe" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Email Address</label>
                        <div class="input-icon" data-icon="üìß">
                            <input type="email" id="regEmail" placeholder="you@example.com" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Password</label>
                        <div class="input-wrapper">
                            <div class="input-icon" data-icon="üîí">
                                <input type="password" id="regPassword" placeholder="Min 8 characters" required>
                            </div>
                            <span class="password-toggle" onclick="togglePassword('regPassword')">üëÅÔ∏è</span>
                        </div>
                        <div class="password-hint">Must be at least 8 characters with uppercase and digit</div>
                    </div>

                    <button type="submit" class="btn btn-primary">
                        <span id="regBtnText">Create Account & Organization</span>
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="showScreen('loginScreen')">
                        Back to Login
                    </button>
                </form>

                <div class="demo-info">
                    <strong>Quick Test:</strong><br>
                    <small>Try creating an account with a new domain name</small>
                </div>
            </div>

            <!-- 2FA Verification Screen -->
            <div id="twoFAScreen" class="screen">
                <p class="text-center">Enter the 6-digit code from your authenticator app</p>

                <form id="twoFAForm">
                    <div class="code-inputs">
                        <input type="text" class="code-input" maxlength="1" data-index="0">
                        <input type="text" class="code-input" maxlength="1" data-index="1">
                        <input type="text" class="code-input" maxlength="1" data-index="2">
                        <input type="text" class="code-input" maxlength="1" data-index="3">
                        <input type="text" class="code-input" maxlength="1" data-index="4">
                        <input type="text" class="code-input" maxlength="1" data-index="5">
                    </div>

                    <button type="submit" class="btn btn-primary">
                        <span id="verify2FABtnText">Verify & Login</span>
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="showScreen('loginScreen')">
                        Cancel
                    </button>
                </form>
            </div>

            <!-- 2FA Setup Screen -->
            <div id="setupTwoFAScreen" class="screen">
                <div class="qr-code-container">
                    <img id="qrCodeImage" class="qr-code-image" src="" alt="QR Code">
                    <div id="qrLoading" class="qr-loading">Loading QR Code...</div>
                </div>

                <div class="text-center">
                    <strong>Or manually enter this code:</strong>
                    <div class="secret-key" id="secretKey"></div>
                </div>

                <div id="backupCodesContainer" class="backup-codes-container">
                    <p class="text-center">
                        <strong>‚ö†Ô∏è Save these backup codes</strong><br>
                        Use them if you lose access to your authenticator
                    </p>
                    <div class="backup-codes" id="backupCodes"></div>
                </div>

                <form id="enable2FAForm">
                    <div class="form-group">
                        <label>Enter Code to Verify</label>
                        <input type="text" id="verifyCode" class="verify-code-input" placeholder="123456" maxlength="6" required>
                    </div>

                    <button type="submit" class="btn btn-primary">
                        <span id="enable2FABtnText">Enable 2FA</span>
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="showScreen('dashboardScreen')">
                        Skip for Now
                    </button>
                </form>
            </div>

            <!-- Dashboard Screen -->
            <div id="dashboardScreen" class="screen">
                <div class="user-info">
                    <div class="user-avatar">üë§</div>
                    <h2 id="userName">Welcome!</h2>
                    <p id="userEmail"></p>
                    <p id="userTenant"></p>
                </div>

                <div class="dashboard">
                    <div class="status-container">
                        <p class="status-label">Account Status</p>
                        <div id="twoFAStatus" class="status-value">
                            üîí 2FA Enabled
                        </div>
                    </div>

                    <button class="btn btn-primary" onclick="showScreen('setupTwoFAScreen'); setup2FA()">
                        ‚öôÔ∏è Setup 2FA
                    </button>
                    <button class="btn btn-secondary" onclick="logout()">
                        üö™ Logout
                    </button>
                </div>
            </div>

            <!-- Create Tenant Screen (Optional - for testing) -->
            <div id="createTenantScreen" class="screen">
                <form id="createTenantForm">
                    <div class="form-group">
                        <label>Organization Name</label>
                        <div class="input-icon" data-icon="üè¢">
                            <input type="text" id="tenantName" placeholder="Acme Corporation" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Domain (subdomain)</label>
                        <div class="input-icon" data-icon="üåê">
                            <input type="text" id="tenantDomain" placeholder="acme-corp" required>
                        </div>
                    </div>

                    <button type="submit" class="btn btn-primary">
                        <span id="createTenantBtnText">Create Organization</span>
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="showScreen('loginScreen')">
                        Back
                    </button>
                </form>

                <div class="text-center">
                    <small class="admin-hint">For testing purposes only</small>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const API_BASE_URL = 'http://localhost:8000';
        
        // State
        let currentUser = null;
        let tempToken = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            setupCodeInputs();
            checkAuth();
            
            // Add "Create Tenant" link for testing
            if (window.location.search.includes('admin')) {
                const loginScreen = document.getElementById('loginScreen');
                const link = document.createElement('div');
                link.className = 'text-center';
                link.innerHTML = '<a class="link" onclick="showScreen(\'createTenantScreen\')">Create Tenant (Admin)</a>';
                loginScreen.appendChild(link);
            }
        });

        // Screen Management
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
            
            // Update header
            const headers = {
                'loginScreen': { title: 'Secure Login', subtitle: 'Multi-Tenant Authentication Platform' },
                'registerScreen': { title: 'Create Account', subtitle: 'Join our secure platform' },
                'twoFAScreen': { title: 'Two-Factor Auth', subtitle: 'Enter your verification code' },
                'setupTwoFAScreen': { title: 'Setup 2FA', subtitle: 'Scan QR code with your app' },
                'dashboardScreen': { title: 'Dashboard', subtitle: 'Welcome back!' },
                'createTenantScreen': { title: 'Create Tenant', subtitle: 'Setup new organization' }
            };
            
            if (headers[screenId]) {
                document.getElementById('headerTitle').textContent = headers[screenId].title;
                document.getElementById('headerSubtitle').textContent = headers[screenId].subtitle;
            }
            
            clearAlerts();
        }

        // Alert Management
        function showAlert(message, type = 'info') {
            const container = document.getElementById('alertContainer');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            container.innerHTML = '';
            container.appendChild(alert);
            
            if (type === 'success') {
                setTimeout(() => alert.remove(), 5000);
            }
        }

        function clearAlerts() {
            document.getElementById('alertContainer').innerHTML = '';
        }

        // Toggle Password Visibility
        function togglePassword(inputId) {
            const input = document.getElementById(inputId);
            input.type = input.type === 'password' ? 'text' : 'password';
        }

        // Code Input Management
        function setupCodeInputs() {
            const inputs = document.querySelectorAll('.code-input');
            
            inputs.forEach((input, index) => {
                input.addEventListener('input', (e) => {
                    const value = e.target.value;
                    if (value && /^\d$/.test(value)) {
                        if (index < inputs.length - 1) {
                            inputs[index + 1].focus();
                        }
                    }
                });
                
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Backspace' && !e.target.value && index > 0) {
                        inputs[index - 1].focus();
                    }
                });
                
                input.addEventListener('paste', (e) => {
                    e.preventDefault();
                    const pasteData = e.clipboardData.getData('text').slice(0, 6);
                    pasteData.split('').forEach((char, i) => {
                        if (inputs[i] && /^\d$/.test(char)) {
                            inputs[i].value = char;
                        }
                    });
                    if (pasteData.length === 6) {
                        inputs[5].focus();
                    }
                });
            });
        }

        function getCodeValue() {
            const inputs = document.querySelectorAll('.code-input');
            return Array.from(inputs).map(input => input.value).join('');
        }

        function clearCodeInputs() {
            document.querySelectorAll('.code-input').forEach(input => input.value = '');
            document.querySelector('.code-input').focus();
        }

        // API Functions
        async function apiCall(endpoint, method = 'GET', body = null, token = null) {
            const options = {
                method,
                headers: {
                    'Content-Type': 'application/json',
                }
            };
            
            if (token) {
                options.headers['Authorization'] = `Bearer ${token}`;
            }
            
            if (body) {
                options.body = JSON.stringify(body);
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}${endpoint}`, options);
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.detail || 'An error occurred');
                }
                
                return data;
            } catch (error) {
                throw error;
            }
        }

        // Check Authentication
        function checkAuth() {
            const token = localStorage.getItem('access_token');
            if (token) {
                loadUserInfo(token);
            }
        }

        async function loadUserInfo(token) {
            try {
                const user = await apiCall('/auth/me', 'GET', null, token);
                currentUser = user;
                displayDashboard(user);
                showScreen('dashboardScreen');
            } catch (error) {
                localStorage.removeItem('access_token');
            }
        }

        // Login Form
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            clearAlerts();
            
            const btn = document.getElementById('loginBtnText');
            const originalText = btn.textContent;
            btn.innerHTML = '<span class="loading"></span> Logging in...';
            
            try {
                const data = await apiCall('/auth/login', 'POST', {
                    tenant_domain: document.getElementById('loginDomain').value,
                    email: document.getElementById('loginEmail').value,
                    password: document.getElementById('loginPassword').value
                });
                
                if (data.requires_2fa) {
                    tempToken = data.access_token;
                    showScreen('twoFAScreen');
                    clearCodeInputs();
                    showAlert('Please enter your 2FA code', 'info');
                } else {
                    localStorage.setItem('access_token', data.access_token);
                    // For now, create a mock user object since backend doesn't return user data
                    currentUser = {
                        email: document.getElementById('loginEmail').value,
                        tenant_domain: document.getElementById('loginDomain').value,
                        is_2fa_enabled: false,
                        full_name: 'Test User'
                    };
                    displayDashboard(currentUser);
                    showScreen('dashboardScreen');
                    showAlert('Login successful!', 'success');
                }
            } catch (error) {
                showAlert(error.message, 'error');
            } finally {
                btn.textContent = originalText;
            }
        });

        // Register Form
        document.getElementById('registerForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            clearAlerts();
            
            const btn = document.getElementById('regBtnText');
            const originalText = btn.textContent;
            btn.innerHTML = '<span class="loading"></span> Creating account...';
            
            const tenantDomain = document.getElementById('regDomain').value;
            const email = document.getElementById('regEmail').value;
            const password = document.getElementById('regPassword').value;
            const name = document.getElementById('regName').value;
            
            try {
                // First, try to register the user
                const data = await apiCall('/auth/register', 'POST', {
                    tenant_domain: tenantDomain,
                    email: email,
                    password: password,
                    name: name
                });
                
                showAlert('Account created! Please login.', 'success');
                setTimeout(() => {
                    document.getElementById('loginEmail').value = data.email;
                    document.getElementById('loginDomain').value = data.tenant_domain;
                    showScreen('loginScreen');
                }, 2000);
            } catch (error) {
                if (error.message.includes('Tenant not found')) {
                    // If tenant doesn't exist, offer to create it
                    const createTenant = confirm(`Organization "${tenantDomain}" doesn't exist. Would you like to create it?`);
                    if (createTenant) {
                        await createTenantAndUser(tenantDomain, name, email, password);
                    }
                } else {
                    showAlert(error.message, 'error');
                }
            } finally {
                btn.textContent = originalText;
            }
        });


        // New function to create tenant and user
        async function createTenantAndUser(domain, name, email, password) {
            try {
                showAlert('Creating organization...', 'info');
                
                // Create the tenant first
                const tenantData = await apiCall('/auth/tenant/create', 'POST', {
                    name: name + "'s Organization",
                    domain: domain
                });
                
                showAlert('Organization created! Now creating your account...', 'success');
                
                // Now register the user
                const userData = await apiCall('/auth/register', 'POST', {
                    tenant_domain: domain,
                    email: email,
                    password: password,
            name: name
                });
                
                showAlert('Account created successfully! Please login.', 'success');
                setTimeout(() => {
                    document.getElementById('loginEmail').value = userData.email;
                    document.getElementById('loginDomain').value = userData.tenant_domain;
                    showScreen('loginScreen');
                }, 2000);
                
            } catch (error) {
                showAlert('Failed to create organization: ' + error.message, 'error');
            }
        }

        // 2FA Verification Form
        document.getElementById('twoFAForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            clearAlerts();
            
            const code = getCodeValue();
            if (code.length !== 6) {
                showAlert('Please enter all 6 digits', 'error');
                return;
            }
            
            const btn = document.getElementById('verify2FABtnText');
            const originalText = btn.textContent;
            btn.innerHTML = '<span class="loading"></span> Verifying...';
            
            try {
                const data = await apiCall('/auth/2fa/verify', 'POST', {
                    token: tempToken,
                    totp_code: code
                });
                
                localStorage.setItem('access_token', data.access_token);
                // Create mock user object
                currentUser = {
                    email: document.getElementById('loginEmail').value,
                    tenant_domain: document.getElementById('loginDomain').value,
                    is_2fa_enabled: true,
                    full_name: 'Test User'
                };
                displayDashboard(currentUser);
                showScreen('dashboardScreen');
                showAlert('Login successful!', 'success');
                clearCodeInputs();
            } catch (error) {
                showAlert(error.message, 'error');
                clearCodeInputs();
            } finally {
                btn.textContent = originalText;
            }
        });

        // Setup 2FA - UPDATED
        async function setup2FA() {
            const token = localStorage.getItem('access_token');
            if (!token) {
                showAlert('Please login first', 'error');
                return;
            }
            
            document.getElementById('qrLoading').style.display = 'block';
            document.getElementById('qrCodeImage').style.display = 'none';
            
            try {
                // Setup 2FA for this user (user inferred from token)
                const data = await apiCall('/auth/2fa/setup', 'POST', null, token);
                
                // Display QR code
                document.getElementById('qrCodeImage').src = data.qr_code;
                document.getElementById('qrCodeImage').style.display = 'block';
                document.getElementById('qrLoading').style.display = 'none';
                
                // Display secret
                document.getElementById('secretKey').textContent = data.secret;
                
                showAlert('Scan the QR code with Google Authenticator or similar app', 'info');
            } catch (error) {
                showAlert('Error setting up 2FA: ' + error.message, 'error');
                showScreen('dashboardScreen');
            }
        }

        // Enable 2FA Form - UPDATED
        document.getElementById('enable2FAForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            clearAlerts();
            
            const code = document.getElementById('verifyCode').value.trim();
            const token = localStorage.getItem('access_token');
            
            // Validate code
            if (!code || code.length !== 6 || !/^\d+$/.test(code)) {
                showAlert('Please enter a valid 6-digit code', 'error');
                return;
            }
            
            const btn = document.getElementById('enable2FABtnText');
            const originalText = btn.textContent;
            btn.innerHTML = '<span class="loading"></span> Enabling...';
            
            try {
                console.log('Starting 2FA enable process...');
                console.log('TOTP code to verify:', code);
                
                // Enable 2FA (user inferred from token)
                const result = await apiCall('/auth/2fa/enable', 'POST', {
                    totp_code: code
                }, token);
                
                console.log('2FA enable result:', result);
                
                showAlert('2FA enabled successfully!', 'success');
                
                // Update user info
                if (currentUser) {
                    currentUser.is_2fa_enabled = true;
                }
                
                setTimeout(() => {
                    displayDashboard(currentUser);
                    showScreen('dashboardScreen');
                }, 2000);
                
            } catch (error) {
                console.error('Error enabling 2FA:', error);
                showAlert('Error enabling 2FA: ' + error.message, 'error');
            } finally {
                btn.textContent = originalText;
            }
        });

        // Create Tenant Form
        document.getElementById('createTenantForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            clearAlerts();
            
            const btn = document.getElementById('createTenantBtnText');
            const originalText = btn.textContent;
            btn.innerHTML = '<span class="loading"></span> Creating...';
            
            try {
                await apiCall('/auth/tenant/create', 'POST', {
                    name: document.getElementById('tenantName').value,
                    domain: document.getElementById('tenantDomain').value
                });
                
                showAlert('Tenant created successfully!', 'success');
                setTimeout(() => {
                    document.getElementById('loginDomain').value = document.getElementById('tenantDomain').value;
                    showScreen('registerScreen');
                }, 2000);
            } catch (error) {
                showAlert(error.message, 'error');
            } finally {
                btn.textContent = originalText;
            }
        });

        // Display Dashboard
        function displayDashboard(user) {
            document.getElementById('userName').textContent = user.full_name || 'Welcome!';
            document.getElementById('userEmail').textContent = user.email;
            document.getElementById('userTenant').textContent = `Organization: ${user.tenant_domain}`;
            
            const statusDiv = document.getElementById('twoFAStatus');
            if (user.is_2fa_enabled) {
                statusDiv.innerHTML = 'üîí 2FA Enabled';
                statusDiv.style.color = '#28a745';
            } else {
                statusDiv.innerHTML = '‚ö†Ô∏è 2FA Not Enabled';
                statusDiv.style.color = '#ffc107';
            }
        }

        // Logout
        function logout() {
            localStorage.removeItem('access_token');
            currentUser = null;
            tempToken = null;
            showScreen('loginScreen');
            showAlert('Logged out successfully', 'info');
            
            // Clear forms
            document.getElementById('loginForm').reset();
            document.getElementById('registerForm').reset();
        }
    </script>
</body>
</html>
```